# Assign layer names to stacks
names(stack0) <- scenarionames[1:9]
# Stack stacks to nc       2/2
# writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],".nc"),
#          varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
# writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],"_EL.nc"),
#          varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],"_LA.nc"),
varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
print(paste('done with C =', fl))
} # end of fl loop
# S5.4_mapping read files and create dataframes for mapping
# for all the scenarios limits for the C are the same
library(terra)
library(raster)
library(rgdal)
library(rgeos)
library(colorRamps)
library(maps)
library(ggplot2)
library(dplyr) # used to pick >=3 continous months
library(rasterVis)
library(grid)
library(scales)
library(viridis)  # better colors for everyone
library(ggthemes) # theme_map()
library(ggpubr) # theme_map()
library(gridExtra)
# install.packages('ggthemes')
# library to read matlab data formats into R
library(R.matlab)
#### set file dir
perturb_names = c('S5.3_allmonths_perturbation_P22','T5.3_allmonths_perturbation_P22','O5.3_allmonths_perturbation_P22')
perturbv = 2
# questname <- 'S5.3_naremoved_quantile_GL_output'
questname <- perturb_names[perturbv]# change input 1/2
filedir <- paste0('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/', questname,"/new",sep='') # input folder
# filedir <- paste0('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/', questname,sep='') # input folder
odir <- paste0("~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/A1_S6_output/",questname)  # change input
idgrid <- as.data.frame(readMat('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/S1.2_siteid_dataframe.mat')[[1]])
dir.create(odir)
# ----- chanve scenario names 4/5
#scenarionames<-c('p','t','v','r','pt','pv','pr','tv','tr','vr','ptvr') #  original scenarios
scenarionames<-c('p','t','v','r','ptvr','f','ptvrf','pv','tr','i') #   9+1
#### convert 2D dataframe idgrid into 3 columns geo dataframe with lat and lon info  for ploting ####
idgrid_matrix <-as.matrix(idgrid)
idgrid_matrix[idgrid_matrix==0] <- NA
idgrid_matrix_flip <- idgrid_matrix[nrow(idgrid_matrix):1,]
# Turn the matrix into a raster
rastidgrid <- raster(idgrid_matrix_flip)
# Give it lat/lon coords for 36-37°E, 3-2°S
extent(rastidgrid) <- c(-180,180,-90,90)
# ... and assign a projection
projection(rastidgrid) <- CRS("+proj=longlat +datum=WGS84")
# plot(rastidgrid)
dfidgrid <- as.data.frame(rastidgrid,xy=TRUE)
colnames(dfidgrid) <- c( "x", "y","value")
#### set ups ####
fluxnamev <- c('GPP','NEE','ER','Ra','Rh','Rh2ER','BurnedC','NBE','ABGB','leafC','woodC')
fluxunitv <- expression('gC/m'^'2/month')
poolunitv <- expression('gC/m'^'2')
# drydata <- read.csv(paste('~/RESEARCH/WORKFLOW/A1_TROPIC_C/S5_drymonths_globe.csv',sep=''),header = T)
# pixelid_GL=c(2221,2022,2122,2222,1623,1723,1823,1923,2023,2123,2223,1624,1724,1824,1924,2024,2124,2224,1625,1725,1825,1925,2025,2125,2225,1626,1726,1826,1926,2026,2126,2226,1727,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2736,2537,2637,2737,2538,2638,2738,2439,2539,2639,2739,2440,2540,2640,2740,2441,2541,2641,2741,2442,2542,2642,2742,2443,2543,2643,2743,2444,2544,2644,2744,2445,2545,2645,2745,2446,2546,2646,2746,2647,2339,1740,1840,1940,2040,2140,2240,2340,1641,1741,1841,1941,2041,2141,2241,2341,1642,1742,1842,1942,2042,2142,2242,2342,1643,1743,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1760,1661,1761,1861,1662,1762,1862,1962,1663,1763,1863,1963,2063,1664,1764,1864,1964,2064,1665,1765,1865,1965,1666,1766,1866,1966,1667,1767)
# deleted 30S 169 pixels left
pixelid_GL=c(2221,2022,2122,2222,1823,1923,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2736,2537,2637,2737,2538,2638,2738,2439,2539,2639,2739,2440,2540,2640,2740,2441,2541,2641,2741,2442,2542,2642,2742,2443,2543,2643,2743,2444,2544,2644,2744,2445,2545,2645,2745,2446,2546,2646,2746,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1861,1862,1962,1863,1963,2063,1864,1964,2064,1865,1965,1866,1966)
# deleted low biomass - 149 pixels left
pixelid_GL=c(2221,2022,2122,2222,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2537,2637,2538,2638,2439,2539,2639,2440,2540,2640,2441,2541,2641,2442,2542,2642,2443,2543,2643,2444,2544,2644,2445,2545,2645,2745,2446,2546,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1962,2063,1964,2064,1965,1866,1966)
# deleted low biomass second row in desert
pixelid_GL=c(2221,2022,2122,2222,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2537,2637,2538,2439,2539,2440,2540,2441,2541,2442,2542,2443,2543,2444,2544,2644,2445,2545,2645,2745,2446,2546,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1962,2063,1964,2064,1965,1866,1966)
# Sept 14 change
# pixelid_GL_exclude_desert=c(2221,2122,2222,2123,2223,1624,1724,1824,1924,2024,2124,2224,1625,1725,1825,1925,2025,2125,2225,1626,1726,1826,1926,2026,2126,2226,1727,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2535,2635,2536,2636,2537,2637,2538,2638,2439,2539,2639,2440,2540,2640,2441,2541,2641,2442,2542,2642,2443,2543,2643,2444,2544,2644,2445,2545,2645,2446,2546,2646,2339,1740,1840,1940,2040,2140,2240,2340,1641,1741,1841,1941,2041,2141,2241,2341,1642,1742,1842,1942,2042,2142,2242,2342,1643,1743,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1865,1965,1766,1866,1667,1767)
# pixelid_GL <- pixelid_GL_exclude_desert
landpix<-pixelid_GL
# input choose continent, remember to change pdf file name as well
xlimv <- c(-80,150) # range(sitelon) # globe
ylimv <- c(-24,24)  # range(sitelat) # globe
# xlimv <- c(60,155) # asia
# ylimv <- c(-30,30)  # asia
# xlimv <- c(-30,60) # africa
# ylimv <- c(-30,30)  # africa
# xlimv <- c(-115,-30) # america
# ylimv <- c(-30,30)  # america
xlabv = "Longitude"
ylabv = "Latitude"
# # get what is not in the elog for pixelid_GL
# elog <- as.numeric(read.csv(paste(filedir,'/elog.csv',sep=''),header = F))
# # elog <- as.numeric(read.csv(paste('~/RESEARCH/WORKFLOW/A1_TROPIC_C/S5.3_output/elog.csv',sep=''),header = F))
# donepix<-setdiff(pixelid_GL,elog)
donepix<-pixelid_GL
# plot set ups
# xlimv = extent(domainlines_WGS84)[1:2]
# ylimv = extent(domainlines_WGS84)[3:4]
coastlines <- readOGR("~/RESEARCH/DATA/shape_files/coastline_shapefiles/gshhg-shp-2.3.7/GSHHS_shp/c/GSHHS_c_L1.shp")
class(coastlines)
extent(coastlines)
psizev = 0.2
borderv = 0.5
#### # 1) change QM/RM, 2) change (,,1/2/3), 3) change nc file name ####
# optionsv <- c('OM')
# optionsv <- c('QM') # 1 for EL, 2 for all years, 3 for LA, search 'options'
optionsv <- c('RM')
# optionsv <- c('JNM','JM','ANM','AM')
titlenamesv <- c('TSmean: (origial_C-perturbed_C)/mean_met_dif','TSmean: origial_C-perturbed_C',
'LastTP: (origial_C-perturbed_C)/mean_met_dif','LastTP: origial_C-perturbed_C')
titleexpv <- c('+value means directional changes of C and mean_met_dif are the same',
'+value means decreased C in perturbed runs',
'+value means directional changes of C and mean_met_dif are the same',
'+value means decreased C in perturbed runs')
# for (fl in c(9,1:5,7,8,10,11)){ # plot ABGB and GPP first
# Create extent for making raster stacks
my_ext <- ext(c(-180, 180, -90, 90))
# for (fl in c(2:5,10:11)){
# for (fl in c(1,8,9)){ # plot # c fluxes uses JNM  # change input 2/2
# for (fl in c(1:5,7:8)){ # plot # c fluxes uses JNM  # change input 2/2
for (fl in c(1:5)){ # plot # c fluxes uses JNM  # change input 2/2
ov=1 # OM only
# create a large matrix to figure out the range (limits) of each C in all 11 scenarios for easy comparison
range_matrix <- matrix(NA,nrow = 46*72, ncol = 11) # this matrix stores 11 scenarios (col) of 46*72 grid cell values
list_dfmap0  <- list()
list_dfmap1  <- list()
for (sc in 1:9){
# initialize map every time, map0 is for dcdmet, map1 is for catogories of nosolution/short/long drought
map0 <- matrix(NA,nrow = 46, ncol = 72)
noshortdryid <- c()
nosolutionid <- c()
for (i in 1:length(landpix)){
siteid <- as.numeric(landpix[i])
siteindex <- which(pixelid_GL==siteid)
rowv <- which(idgrid == siteid,arr.ind=TRUE)[1]
colv <- which(idgrid == siteid,arr.ind=TRUE)[2]
##### option 2 OM/QM ###
data2  <- readMat(paste0(filedir,'/',list.files(path=filedir,pattern=paste0('\\_',siteid,'_drymonths_',optionsv,'.mat$'))))
# map0[rowv,colv]<-data2[[1]][,,1][fl,sc] # EL years options  1/2
map0[rowv,colv]<-data2[[1]][,,2][fl,sc] # all years
# map0[rowv,colv]<-data2[[1]][,,3][fl,sc] # LA years
# alphav=0.2
# plot(1:144,dcdmet_TS,type='l',col='red')
# abline(h=dcdmet,lty='dotted')
# # lines(1:144,dcdmet_TS_up)
# polygon(c(1:144,rev(1:144)),c(dcdmet_TS_low,rev(dcdmet_TS_up)),col=alpha("red",alphav),border=NA)
# mtext(paste0("TS mean of ppd median dc/dmet = ",round(dcdmet,2)),adj = 0.1,side = 3,line = -2)
# # remove timeseries containing na, investigate later
# if ((sum(is.na(tsfluxsw))+sum(is.na(tsflux))) !=0){
#   map0[rowv,colv]<-NA
#   map1[rowv,colv] = 4
# }
# }
} #end of global pixels
# data quality control
range(map0,na.rm = T)
map0[map0 < -1e5]=NA
map0[map0 > 1e5]=NA
range(map0,na.rm = T)
# now  that  I have the matrix of data, I know it's 4by5, convert matrix to SpatRaster
# flip upside down so lat goes -90 to 90
map0 <- map0[nrow(map0):1,]
# Turn the matrix into a raster
map0 <- rast(map0, crs = "+proj=longlat +datum=WGS84")
ext(map0) <- my_ext
# Stack rasters
if (sc == 1) {
stack0 <- map0
} else {
stack0 <- c(stack0, map0)
}
print(paste('done with sc =', sc))
} # end of sc loop
# Assign layer names to stacks
names(stack0) <- scenarionames[1:9]
# Stack stacks to nc       2/2
writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],".nc"),
varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
# writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],"_EL.nc"),
#          varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
# writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],"_LA.nc"),
# varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
print(paste('done with C =', fl))
} # end of fl loop
# S5.4_mapping read files and create dataframes for mapping
# for all the scenarios limits for the C are the same
library(terra)
library(raster)
library(rgdal)
library(rgeos)
library(colorRamps)
library(maps)
library(ggplot2)
library(dplyr) # used to pick >=3 continous months
library(rasterVis)
library(grid)
library(scales)
library(viridis)  # better colors for everyone
library(ggthemes) # theme_map()
library(ggpubr) # theme_map()
library(gridExtra)
# install.packages('ggthemes')
# library to read matlab data formats into R
library(R.matlab)
#### set file dir
perturb_names = c('S5.3_allmonths_perturbation_P22','T5.3_allmonths_perturbation_P22','O5.3_allmonths_perturbation_P22')
perturbv = 2
# questname <- 'S5.3_naremoved_quantile_GL_output'
questname <- perturb_names[perturbv]# change input 1/2
filedir <- paste0('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/', questname,"/new",sep='') # input folder
# filedir <- paste0('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/', questname,sep='') # input folder
odir <- paste0("~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/A1_S6_output/",questname)  # change input
idgrid <- as.data.frame(readMat('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/S1.2_siteid_dataframe.mat')[[1]])
dir.create(odir)
# ----- chanve scenario names 4/5
#scenarionames<-c('p','t','v','r','pt','pv','pr','tv','tr','vr','ptvr') #  original scenarios
scenarionames<-c('p','t','v','r','ptvr','f','ptvrf','pv','tr','i') #   9+1
#### convert 2D dataframe idgrid into 3 columns geo dataframe with lat and lon info  for ploting ####
idgrid_matrix <-as.matrix(idgrid)
idgrid_matrix[idgrid_matrix==0] <- NA
idgrid_matrix_flip <- idgrid_matrix[nrow(idgrid_matrix):1,]
# Turn the matrix into a raster
rastidgrid <- raster(idgrid_matrix_flip)
# Give it lat/lon coords for 36-37°E, 3-2°S
extent(rastidgrid) <- c(-180,180,-90,90)
# ... and assign a projection
projection(rastidgrid) <- CRS("+proj=longlat +datum=WGS84")
# plot(rastidgrid)
dfidgrid <- as.data.frame(rastidgrid,xy=TRUE)
colnames(dfidgrid) <- c( "x", "y","value")
#### set ups ####
fluxnamev <- c('GPP','NEE','ER','Ra','Rh','Rh2ER','BurnedC','NBE','ABGB','leafC','woodC')
fluxunitv <- expression('gC/m'^'2/month')
poolunitv <- expression('gC/m'^'2')
# drydata <- read.csv(paste('~/RESEARCH/WORKFLOW/A1_TROPIC_C/S5_drymonths_globe.csv',sep=''),header = T)
# pixelid_GL=c(2221,2022,2122,2222,1623,1723,1823,1923,2023,2123,2223,1624,1724,1824,1924,2024,2124,2224,1625,1725,1825,1925,2025,2125,2225,1626,1726,1826,1926,2026,2126,2226,1727,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2736,2537,2637,2737,2538,2638,2738,2439,2539,2639,2739,2440,2540,2640,2740,2441,2541,2641,2741,2442,2542,2642,2742,2443,2543,2643,2743,2444,2544,2644,2744,2445,2545,2645,2745,2446,2546,2646,2746,2647,2339,1740,1840,1940,2040,2140,2240,2340,1641,1741,1841,1941,2041,2141,2241,2341,1642,1742,1842,1942,2042,2142,2242,2342,1643,1743,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1760,1661,1761,1861,1662,1762,1862,1962,1663,1763,1863,1963,2063,1664,1764,1864,1964,2064,1665,1765,1865,1965,1666,1766,1866,1966,1667,1767)
# deleted 30S 169 pixels left
pixelid_GL=c(2221,2022,2122,2222,1823,1923,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2736,2537,2637,2737,2538,2638,2738,2439,2539,2639,2739,2440,2540,2640,2740,2441,2541,2641,2741,2442,2542,2642,2742,2443,2543,2643,2743,2444,2544,2644,2744,2445,2545,2645,2745,2446,2546,2646,2746,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1861,1862,1962,1863,1963,2063,1864,1964,2064,1865,1965,1866,1966)
# deleted low biomass - 149 pixels left
pixelid_GL=c(2221,2022,2122,2222,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2537,2637,2538,2638,2439,2539,2639,2440,2540,2640,2441,2541,2641,2442,2542,2642,2443,2543,2643,2444,2544,2644,2445,2545,2645,2745,2446,2546,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1962,2063,1964,2064,1965,1866,1966)
# deleted low biomass second row in desert
pixelid_GL=c(2221,2022,2122,2222,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2537,2637,2538,2439,2539,2440,2540,2441,2541,2442,2542,2443,2543,2444,2544,2644,2445,2545,2645,2745,2446,2546,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1962,2063,1964,2064,1965,1866,1966)
# Sept 14 change
# pixelid_GL_exclude_desert=c(2221,2122,2222,2123,2223,1624,1724,1824,1924,2024,2124,2224,1625,1725,1825,1925,2025,2125,2225,1626,1726,1826,1926,2026,2126,2226,1727,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2535,2635,2536,2636,2537,2637,2538,2638,2439,2539,2639,2440,2540,2640,2441,2541,2641,2442,2542,2642,2443,2543,2643,2444,2544,2644,2445,2545,2645,2446,2546,2646,2339,1740,1840,1940,2040,2140,2240,2340,1641,1741,1841,1941,2041,2141,2241,2341,1642,1742,1842,1942,2042,2142,2242,2342,1643,1743,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1865,1965,1766,1866,1667,1767)
# pixelid_GL <- pixelid_GL_exclude_desert
landpix<-pixelid_GL
# input choose continent, remember to change pdf file name as well
xlimv <- c(-80,150) # range(sitelon) # globe
ylimv <- c(-24,24)  # range(sitelat) # globe
# xlimv <- c(60,155) # asia
# ylimv <- c(-30,30)  # asia
# xlimv <- c(-30,60) # africa
# ylimv <- c(-30,30)  # africa
# xlimv <- c(-115,-30) # america
# ylimv <- c(-30,30)  # america
xlabv = "Longitude"
ylabv = "Latitude"
# # get what is not in the elog for pixelid_GL
# elog <- as.numeric(read.csv(paste(filedir,'/elog.csv',sep=''),header = F))
# # elog <- as.numeric(read.csv(paste('~/RESEARCH/WORKFLOW/A1_TROPIC_C/S5.3_output/elog.csv',sep=''),header = F))
# donepix<-setdiff(pixelid_GL,elog)
donepix<-pixelid_GL
# plot set ups
# xlimv = extent(domainlines_WGS84)[1:2]
# ylimv = extent(domainlines_WGS84)[3:4]
coastlines <- readOGR("~/RESEARCH/DATA/shape_files/coastline_shapefiles/gshhg-shp-2.3.7/GSHHS_shp/c/GSHHS_c_L1.shp")
class(coastlines)
extent(coastlines)
psizev = 0.2
borderv = 0.5
#### # 1) change QM/RM, 2) change (,,1/2/3), 3) change nc file name ####
# optionsv <- c('OM')
# optionsv <- c('QM') # 1 for EL, 2 for all years, 3 for LA, search 'options'
optionsv <- c('RM')
# optionsv <- c('JNM','JM','ANM','AM')
titlenamesv <- c('TSmean: (origial_C-perturbed_C)/mean_met_dif','TSmean: origial_C-perturbed_C',
'LastTP: (origial_C-perturbed_C)/mean_met_dif','LastTP: origial_C-perturbed_C')
titleexpv <- c('+value means directional changes of C and mean_met_dif are the same',
'+value means decreased C in perturbed runs',
'+value means directional changes of C and mean_met_dif are the same',
'+value means decreased C in perturbed runs')
# for (fl in c(9,1:5,7,8,10,11)){ # plot ABGB and GPP first
# Create extent for making raster stacks
my_ext <- ext(c(-180, 180, -90, 90))
# for (fl in c(2:5,10:11)){
# for (fl in c(1,8,9)){ # plot # c fluxes uses JNM  # change input 2/2
# for (fl in c(1:5,7:8)){ # plot # c fluxes uses JNM  # change input 2/2
for (fl in c(1:5)){ # plot # c fluxes uses JNM  # change input 2/2
ov=1 # OM only
# create a large matrix to figure out the range (limits) of each C in all 11 scenarios for easy comparison
range_matrix <- matrix(NA,nrow = 46*72, ncol = 11) # this matrix stores 11 scenarios (col) of 46*72 grid cell values
list_dfmap0  <- list()
list_dfmap1  <- list()
for (sc in 1:9){
# initialize map every time, map0 is for dcdmet, map1 is for catogories of nosolution/short/long drought
map0 <- matrix(NA,nrow = 46, ncol = 72)
noshortdryid <- c()
nosolutionid <- c()
for (i in 1:length(landpix)){
siteid <- as.numeric(landpix[i])
siteindex <- which(pixelid_GL==siteid)
rowv <- which(idgrid == siteid,arr.ind=TRUE)[1]
colv <- which(idgrid == siteid,arr.ind=TRUE)[2]
##### option 2 OM/QM ###
data2  <- readMat(paste0(filedir,'/',list.files(path=filedir,pattern=paste0('\\_',siteid,'_drymonths_',optionsv,'.mat$'))))
map0[rowv,colv]<-data2[[1]][,,1][fl,sc] # EL years options  1/2
# map0[rowv,colv]<-data2[[1]][,,2][fl,sc] # all years
# map0[rowv,colv]<-data2[[1]][,,3][fl,sc] # LA years
# alphav=0.2
# plot(1:144,dcdmet_TS,type='l',col='red')
# abline(h=dcdmet,lty='dotted')
# # lines(1:144,dcdmet_TS_up)
# polygon(c(1:144,rev(1:144)),c(dcdmet_TS_low,rev(dcdmet_TS_up)),col=alpha("red",alphav),border=NA)
# mtext(paste0("TS mean of ppd median dc/dmet = ",round(dcdmet,2)),adj = 0.1,side = 3,line = -2)
# # remove timeseries containing na, investigate later
# if ((sum(is.na(tsfluxsw))+sum(is.na(tsflux))) !=0){
#   map0[rowv,colv]<-NA
#   map1[rowv,colv] = 4
# }
# }
} #end of global pixels
# data quality control
range(map0,na.rm = T)
map0[map0 < -1e5]=NA
map0[map0 > 1e5]=NA
range(map0,na.rm = T)
# now  that  I have the matrix of data, I know it's 4by5, convert matrix to SpatRaster
# flip upside down so lat goes -90 to 90
map0 <- map0[nrow(map0):1,]
# Turn the matrix into a raster
map0 <- rast(map0, crs = "+proj=longlat +datum=WGS84")
ext(map0) <- my_ext
# Stack rasters
if (sc == 1) {
stack0 <- map0
} else {
stack0 <- c(stack0, map0)
}
print(paste('done with sc =', sc))
} # end of sc loop
# Assign layer names to stacks
names(stack0) <- scenarionames[1:9]
# Stack stacks to nc       2/2
# writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],".nc"),
#          varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],"_EL.nc"),
varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
# writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],"_LA.nc"),
# varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
print(paste('done with C =', fl))
} # end of fl loop
# S5.4_mapping read files and create dataframes for mapping
# for all the scenarios limits for the C are the same
library(terra)
library(raster)
library(rgdal)
library(rgeos)
library(colorRamps)
library(maps)
library(ggplot2)
library(dplyr) # used to pick >=3 continous months
library(rasterVis)
library(grid)
library(scales)
library(viridis)  # better colors for everyone
library(ggthemes) # theme_map()
library(ggpubr) # theme_map()
library(gridExtra)
# install.packages('ggthemes')
# library to read matlab data formats into R
library(R.matlab)
#### set file dir
perturb_names = c('S5.3_allmonths_perturbation_P22','T5.3_allmonths_perturbation_P22','O5.3_allmonths_perturbation_P22')
perturbv = 2
# questname <- 'S5.3_naremoved_quantile_GL_output'
questname <- perturb_names[perturbv]# change input 1/2
filedir <- paste0('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/', questname,"/new",sep='') # input folder
# filedir <- paste0('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/', questname,sep='') # input folder
odir <- paste0("~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/A1_S6_output/",questname)  # change input
idgrid <- as.data.frame(readMat('~/RESEARCH/WORKFLOW/A1_TROPIC_C_stage6/S1.2_siteid_dataframe.mat')[[1]])
dir.create(odir)
# ----- chanve scenario names 4/5
#scenarionames<-c('p','t','v','r','pt','pv','pr','tv','tr','vr','ptvr') #  original scenarios
scenarionames<-c('p','t','v','r','ptvr','f','ptvrf','pv','tr','i') #   9+1
#### convert 2D dataframe idgrid into 3 columns geo dataframe with lat and lon info  for ploting ####
idgrid_matrix <-as.matrix(idgrid)
idgrid_matrix[idgrid_matrix==0] <- NA
idgrid_matrix_flip <- idgrid_matrix[nrow(idgrid_matrix):1,]
# Turn the matrix into a raster
rastidgrid <- raster(idgrid_matrix_flip)
# Give it lat/lon coords for 36-37°E, 3-2°S
extent(rastidgrid) <- c(-180,180,-90,90)
# ... and assign a projection
projection(rastidgrid) <- CRS("+proj=longlat +datum=WGS84")
# plot(rastidgrid)
dfidgrid <- as.data.frame(rastidgrid,xy=TRUE)
colnames(dfidgrid) <- c( "x", "y","value")
#### set ups ####
fluxnamev <- c('GPP','NEE','ER','Ra','Rh','Rh2ER','BurnedC','NBE','ABGB','leafC','woodC')
fluxunitv <- expression('gC/m'^'2/month')
poolunitv <- expression('gC/m'^'2')
# drydata <- read.csv(paste('~/RESEARCH/WORKFLOW/A1_TROPIC_C/S5_drymonths_globe.csv',sep=''),header = T)
# pixelid_GL=c(2221,2022,2122,2222,1623,1723,1823,1923,2023,2123,2223,1624,1724,1824,1924,2024,2124,2224,1625,1725,1825,1925,2025,2125,2225,1626,1726,1826,1926,2026,2126,2226,1727,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2736,2537,2637,2737,2538,2638,2738,2439,2539,2639,2739,2440,2540,2640,2740,2441,2541,2641,2741,2442,2542,2642,2742,2443,2543,2643,2743,2444,2544,2644,2744,2445,2545,2645,2745,2446,2546,2646,2746,2647,2339,1740,1840,1940,2040,2140,2240,2340,1641,1741,1841,1941,2041,2141,2241,2341,1642,1742,1842,1942,2042,2142,2242,2342,1643,1743,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1760,1661,1761,1861,1662,1762,1862,1962,1663,1763,1863,1963,2063,1664,1764,1864,1964,2064,1665,1765,1865,1965,1666,1766,1866,1966,1667,1767)
# deleted 30S 169 pixels left
pixelid_GL=c(2221,2022,2122,2222,1823,1923,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2736,2537,2637,2737,2538,2638,2738,2439,2539,2639,2739,2440,2540,2640,2740,2441,2541,2641,2741,2442,2542,2642,2742,2443,2543,2643,2743,2444,2544,2644,2744,2445,2545,2645,2745,2446,2546,2646,2746,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1861,1862,1962,1863,1963,2063,1864,1964,2064,1865,1965,1866,1966)
# deleted low biomass - 149 pixels left
pixelid_GL=c(2221,2022,2122,2222,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2537,2637,2538,2638,2439,2539,2639,2440,2540,2640,2441,2541,2641,2442,2542,2642,2443,2543,2643,2444,2544,2644,2445,2545,2645,2745,2446,2546,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1962,2063,1964,2064,1965,1866,1966)
# deleted low biomass second row in desert
pixelid_GL=c(2221,2022,2122,2222,2023,2123,2223,1824,1924,2024,2124,2224,1825,1925,2025,2125,2225,1826,1926,2026,2126,2226,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2734,2535,2635,2735,2536,2636,2537,2637,2538,2439,2539,2440,2540,2441,2541,2442,2542,2443,2543,2444,2544,2644,2445,2545,2645,2745,2446,2546,2647,2339,1840,1940,2040,2140,2240,2340,1841,1941,2041,2141,2241,2341,1842,1942,2042,2142,2242,2342,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1962,2063,1964,2064,1965,1866,1966)
# Sept 14 change
# pixelid_GL_exclude_desert=c(2221,2122,2222,2123,2223,1624,1724,1824,1924,2024,2124,2224,1625,1725,1825,1925,2025,2125,2225,1626,1726,1826,1926,2026,2126,2226,1727,1827,1927,2027,2127,2227,1828,1928,2028,2128,2228,1929,2029,2129,2229,2719,2720,2321,2322,2422,2522,2622,2323,2423,2523,2623,2324,2424,2524,2624,2325,2425,2525,2326,2426,2327,2328,2535,2635,2536,2636,2537,2637,2538,2638,2439,2539,2639,2440,2540,2640,2441,2541,2641,2442,2542,2642,2443,2543,2643,2444,2544,2644,2445,2545,2645,2446,2546,2646,2339,1740,1840,1940,2040,2140,2240,2340,1641,1741,1841,1941,2041,2141,2241,2341,1642,1742,1842,1942,2042,2142,2242,2342,1643,1743,1843,1943,2043,2143,2243,2343,1844,1944,2044,2144,2244,2344,2045,2345,1846,1946,2752,2852,2753,2853,2856,2457,2757,2857,2358,2758,2858,2360,2460,2265,2266,1865,1965,1766,1866,1667,1767)
# pixelid_GL <- pixelid_GL_exclude_desert
landpix<-pixelid_GL
# input choose continent, remember to change pdf file name as well
xlimv <- c(-80,150) # range(sitelon) # globe
ylimv <- c(-24,24)  # range(sitelat) # globe
# xlimv <- c(60,155) # asia
# ylimv <- c(-30,30)  # asia
# xlimv <- c(-30,60) # africa
# ylimv <- c(-30,30)  # africa
# xlimv <- c(-115,-30) # america
# ylimv <- c(-30,30)  # america
xlabv = "Longitude"
ylabv = "Latitude"
# # get what is not in the elog for pixelid_GL
# elog <- as.numeric(read.csv(paste(filedir,'/elog.csv',sep=''),header = F))
# # elog <- as.numeric(read.csv(paste('~/RESEARCH/WORKFLOW/A1_TROPIC_C/S5.3_output/elog.csv',sep=''),header = F))
# donepix<-setdiff(pixelid_GL,elog)
donepix<-pixelid_GL
# plot set ups
# xlimv = extent(domainlines_WGS84)[1:2]
# ylimv = extent(domainlines_WGS84)[3:4]
coastlines <- readOGR("~/RESEARCH/DATA/shape_files/coastline_shapefiles/gshhg-shp-2.3.7/GSHHS_shp/c/GSHHS_c_L1.shp")
class(coastlines)
extent(coastlines)
psizev = 0.2
borderv = 0.5
#### # 1) change QM/RM, 2) change (,,1/2/3), 3) change nc file name ####
# optionsv <- c('OM')
# optionsv <- c('QM') # 1 for EL, 2 for all years, 3 for LA, search 'options'
optionsv <- c('RM')
# optionsv <- c('JNM','JM','ANM','AM')
titlenamesv <- c('TSmean: (origial_C-perturbed_C)/mean_met_dif','TSmean: origial_C-perturbed_C',
'LastTP: (origial_C-perturbed_C)/mean_met_dif','LastTP: origial_C-perturbed_C')
titleexpv <- c('+value means directional changes of C and mean_met_dif are the same',
'+value means decreased C in perturbed runs',
'+value means directional changes of C and mean_met_dif are the same',
'+value means decreased C in perturbed runs')
# for (fl in c(9,1:5,7,8,10,11)){ # plot ABGB and GPP first
# Create extent for making raster stacks
my_ext <- ext(c(-180, 180, -90, 90))
# for (fl in c(2:5,10:11)){
# for (fl in c(1,8,9)){ # plot # c fluxes uses JNM  # change input 2/2
# for (fl in c(1:5,7:8)){ # plot # c fluxes uses JNM  # change input 2/2
for (fl in c(1:5)){ # plot # c fluxes uses JNM  # change input 2/2
ov=1 # OM only
# create a large matrix to figure out the range (limits) of each C in all 11 scenarios for easy comparison
range_matrix <- matrix(NA,nrow = 46*72, ncol = 11) # this matrix stores 11 scenarios (col) of 46*72 grid cell values
list_dfmap0  <- list()
list_dfmap1  <- list()
for (sc in 1:9){
# initialize map every time, map0 is for dcdmet, map1 is for catogories of nosolution/short/long drought
map0 <- matrix(NA,nrow = 46, ncol = 72)
noshortdryid <- c()
nosolutionid <- c()
for (i in 1:length(landpix)){
siteid <- as.numeric(landpix[i])
siteindex <- which(pixelid_GL==siteid)
rowv <- which(idgrid == siteid,arr.ind=TRUE)[1]
colv <- which(idgrid == siteid,arr.ind=TRUE)[2]
##### option 2 OM/QM ###
data2  <- readMat(paste0(filedir,'/',list.files(path=filedir,pattern=paste0('\\_',siteid,'_drymonths_',optionsv,'.mat$'))))
# map0[rowv,colv]<-data2[[1]][,,1][fl,sc] # EL years options  1/2
# map0[rowv,colv]<-data2[[1]][,,2][fl,sc] # all years
map0[rowv,colv]<-data2[[1]][,,3][fl,sc] # LA years
# alphav=0.2
# plot(1:144,dcdmet_TS,type='l',col='red')
# abline(h=dcdmet,lty='dotted')
# # lines(1:144,dcdmet_TS_up)
# polygon(c(1:144,rev(1:144)),c(dcdmet_TS_low,rev(dcdmet_TS_up)),col=alpha("red",alphav),border=NA)
# mtext(paste0("TS mean of ppd median dc/dmet = ",round(dcdmet,2)),adj = 0.1,side = 3,line = -2)
# # remove timeseries containing na, investigate later
# if ((sum(is.na(tsfluxsw))+sum(is.na(tsflux))) !=0){
#   map0[rowv,colv]<-NA
#   map1[rowv,colv] = 4
# }
# }
} #end of global pixels
# data quality control
range(map0,na.rm = T)
map0[map0 < -1e5]=NA
map0[map0 > 1e5]=NA
range(map0,na.rm = T)
# now  that  I have the matrix of data, I know it's 4by5, convert matrix to SpatRaster
# flip upside down so lat goes -90 to 90
map0 <- map0[nrow(map0):1,]
# Turn the matrix into a raster
map0 <- rast(map0, crs = "+proj=longlat +datum=WGS84")
ext(map0) <- my_ext
# Stack rasters
if (sc == 1) {
stack0 <- map0
} else {
stack0 <- c(stack0, map0)
}
print(paste('done with sc =', sc))
} # end of sc loop
# Assign layer names to stacks
names(stack0) <- scenarionames[1:9]
# Stack stacks to nc       2/2
# writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],".nc"),
#          varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
# writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],"_EL.nc"),
#          varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
writeCDF(stack0, filename = paste0(odir,"/",fluxnamev[fl],"_",optionsv[ov],"_LA.nc"),
varname = fluxnamev[fl], unit = "gC/m-2/month-1",overwrite=TRUE)
print(paste('done with C =', fl))
} # end of fl loop
